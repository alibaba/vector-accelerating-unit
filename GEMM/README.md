# GEMM submodule
The GEMM(General Matrix Multipication) core supports basic matrix multiplication operations. It receives commands through command fifo; load/store data from/to shared memory; push response to response fifo.

The GEMM Core computes K matrix multiplications (each is N\*N x N\*N), and accumulates consecutive K output matrices. Effectively, it computes a N\*kN x kN\*N matrix multiplication. 
N is a design related parameter (dimension size of the systolic array), and K is a workload parameter from XoCC GEMM instructions.

This unit support the following XoCC commands:
- gemm_read: set start address for reading weight, attribute and bias
- gemm_start: specify result write back start address and block size k, initiate GEMM operation

With this two commands, a single GEMM operation can complete the following operations:
(A is a matrix of N\*kN, and B is a matrix of kN\*N. accu refers to the accumulator buffer, if results are wrote to accu, the computation results will be stored in buffer and not write to shared memory. 'out' means the results in accumulator buffer are wrote to shared memory. A fresh start refers to chear accumulator buffer before a gemm operation.)
- out = A * B + Accu
- accu = A * B + accu
- fresh start, out = A * B
- accu = A * B
- out = relu(A * B + accu)
- fresh start, out = relu(A * B)
- accu = bias; out = A * B + bias
- accu = bias; accu = A * B + bias
- accu = bias; out = relu(A * B + bias)

GEMM submodules:
- xocc_inerface: get command from command fifo and write response to response fifo, decode incoming command and control the start of gemm operations
- gemm_axim_top: axi master interface to read/write data from/to weight memory or shared memory
- systolic_array: computation unit to issue matrix multiplication
- accumulator: accumulate partial result

The following IPs are generated by Xilinx vivado (not provided in this repo):
- fp32_adder_xilinx: floating point adder
- fp32_mult_xilinx:	floating point multiplier
- fp32_acc_xilinx: floating point adder
- fifo_16x96: fifo
- BUFGCE

The latency configurations of these IPs should be the same as parameters specified in gemm_core_top, which are ADDER_LATENCY, MULT_LATENCY and ACC_LATENCY.

Typical dataflow is as follows:
1. xocc gemm instructions are stored in order in cmd_fifo, cmd_fifo_empty = 0ï¼›
2. When cmd_fifo is not empty, enable cmd_fifo_rd_en to get instructions and pushed into gemm_cmd_fifo until gemm_cmd_fifo is almost full or cmd_fifo becomes empty;
3. When gemm is idle and gemm_cmd_fifo is not empty, pop command from gemm_cmd_fifo and send to xocc_decoder unit;
4. Stop pop when detect gemm_start command, decoder decode command to specify weight, bias (if need) attribute and result write back start address for issuing axi read/write transactions;
5. These informations are grouped and sent to group_dispatch unit;
6. The group_dispatch unit start initiate AXI read transactions to get (bias) and weight from weight memory and get attribute from shared memory with a certain time sequence;
7. Weight, bias and attribute data are sent to dpe module, which include systolic_array and accumulator;
8. Results are stored in accumulator buffer or write back to shared memory (the write back address is obtained in gemm_start command) with accumulator buffer flushed;
9. After that, if not in silent mode (specified in gemm_start command), send status done to rsp_fifo to indicate completion of a single operation.
10. Repeat  4~9.